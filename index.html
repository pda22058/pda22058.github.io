<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Ocean Survival â€” A-Frame</title>
Â  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
Â  <script src="https://unpkg.com/@c-frame/aframe-particle-system-component@1.2.x/dist/aframe-particle-system-component.min.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/aframe-simple-sun-sky@^1.2.2/simple-sun-sky.js"></script>
Â  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
Â  <style>
Â  Â  body { margin:0; }
Â  Â  .hud { position: fixed; left: 12px; top: 12px; font: 14px/1.4 system-ui, sans-serif; color: #fff; z-index: 10; }
Â  Â  .hud .pill { background: rgba(0,0,0,.45); padding: 8px 10px; border-radius: 10px; margin-bottom: 6px; }
Â  </style>
</head>
<body>
Â  <div class="hud">
Â  Â  <div class="pill">WASD to move â€¢ Mouse to look â€¢ Enter VR if supported</div>
Â  Â  <div class="pill">Avoid the glowing red circles. Stay safe!</div>
Â  Â  <div id="meter" class="pill">Survival: 100%</div>
Â  Â  <div id="status" class="pill">Status: Ready</div>
Â  </div>

Â  <a-scene>
Â  Â  <a-assets timeout="30000">
Â  Â  Â  <a-asset-item id="bottleGLTF" src="./assets/models/military_water_bottle/scene.gltf"></a-asset-item>
Â  Â  Â  <a-asset-item id="sharkGLTF"Â  src="./assets/models/great_white_shark_attack_bite_animation_loop/scene.gltf"></a-asset-item>
Â  Â  </a-assets>

Â  Â  <a-entity id="rain" particle-system="preset: rain; color: #aee7ff; particleCount: 20"></a-entity>

Â  Â  Â  Â  <a-entity id="ocean" ocean="density: 40; amplitude: 0.2; width: 1000; depth: 1000; speed: 4"
Â  Â  Â  Â  Â  Â  Â  material="color: #192f3d; opacity: 0.75; metalness: 0; roughness: 1"
Â  Â  Â  Â  Â  Â  Â  rotation="-90 0 0"></a-entity>

Â  Â  Â  Â  <a-entity id="deep-ocean"Â 
Â  Â  Â  Â  ocean="density: 40; amplitude: 0.2; width: 1000; depth: 1000; speed: 4"
Â  Â  Â  Â  material="color: #192f3d; opacity: 0.75; metalness: 0; roughness: 1"
Â  Â  Â  Â  rotation="-90 0 0"Â 
Â  Â  Â  Â  position="0 -3 0">
Â  Â  </a-entity>

Â  Â  <a-simple-sun-sky sun-position="1 0.4 0"></a-simple-sun-sky>
Â  Â  <a-entity light="type: ambient; color: #888"></a-entity>

Â  Â  Â  Â  <a-entity id="rig" position="0 0.7 0"Â 
Â  Â  Â  Â  movement-controls="speed: 0.2"> 
Â  Â  Â  <a-entity id="player" camera look-controls position="0 -0.3 0"></a-entity>
Â  Â  </a-entity>

Â  Â  Â  Â  <a-entity id="collectibles"></a-entity>

Â  Â  Â  Â  <a-entity id="game" game-manager target-spawner="intervalMin: 4000; intervalMax: 7000; radius: 25; count: 2; minSep: 6"></a-entity>
Â  </a-scene>

Â  <script>
Â  function randRange(min,max){ return Math.random()*(max-min)+min; }
Â  const statusEl = document.getElementById('status');
Â  const meterElÂ  = document.getElementById('meter');
Â  function setStatus(t){ statusEl.textContent = 'Status: ' + t; }
Â  function setMeter(v){ meterEl.textContentÂ  = 'Survival: ' + Math.round(v) + '%'; }

Â  /* Uniform scale after model loads (used by bottles and shark) */
Â  AFRAME.registerComponent('shrink-on-load', {
Â  Â  schema: { s: {default: 0.002} },
Â  Â  init () {
Â  Â  Â  const apply = () => this.el.object3D.scale.setScalar(this.data.s);
Â  Â  Â  if (this.el.getObject3D('mesh')) apply();
Â  Â  Â  this.el.addEventListener('model-loaded', apply, {once:true});
Â  Â  }
Â  });

Â  /* Core game manager (Logic updated to force a 50x50 spawning area) */
Â  AFRAME.registerComponent('game-manager', {
Â  Â  init(){
Â  Â  Â  this.isGameOver = false;
Â  Â  Â  this.player = document.querySelector('#rig');

Â  Â  Â  // ğŸ“ Forced to 50x50 boundary for bottle spawning (25 - 2 buffer = 23)
Â  Â  Â  this.halfW = 25; 
Â  Â  Â  this.halfD = 25;

Â  Â  Â  this.survival = 100;
Â  Â  Â  setMeter(this.survival);
Â  Â  Â  this.decayTimer = setInterval(() => {
Â  Â  Â  Â  if (!this.isGameOver) this.adjustSurvival(-10);
Â  Â  Â  }, 10000);

Â  Â  Â  this.isSpawning = false;
Â  Â  Â  window.addEventListener('bottle-collected', () => {
Â  Â  Â  Â  this.adjustSurvival(+10);
Â  Â  Â  Â  this.spawnIfNone();
Â  Â  Â  });

Â  Â  Â  this.spawnIfNone();
Â  Â  },

Â  Â  adjustSurvival(delta){
Â  Â  Â  if (this.isGameOver) return;
Â  Â  Â  this.survival = Math.max(0, Math.min(100, this.survival + delta));
Â  Â  Â  setMeter(this.survival);
Â  Â  Â  if (this.survival <= 0){
Â  Â  Â  Â  setStatus('Energy depleted.');
Â  Â  Â  Â  this.gameOver();
Â  Â  Â  }
Â  Â  },

Â  Â  spawnIfNone(){
Â  Â  Â  if (this.isGameOver) return;
Â  Â  Â  const parent = document.getElementById('collectibles');
Â  Â  Â  if (this.isSpawning || parent.childElementCount > 0) return;
Â  Â  Â  this.isSpawning = true;
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  this.spawnOneBottle();
Â  Â  Â  Â  this.isSpawning = false;
Â  Â  Â  }, 0);
Â  Â  },

Â  Â  gameOver(){
Â  Â  Â  if(this.isGameOver) return;
Â  Â  Â  this.isGameOver = true;
Â  Â  Â  setStatus('Game Over');
Â  Â  Â  if (this.decayTimer) { clearInterval(this.decayTimer); this.decayTimer = null; }
Â  Â  Â Â 
Â  Â  Â  const overlay = document.createElement('div');
Â  Â  Â  overlay.style.cssText = 'position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;transition:opacity .6s;display:flex;align-items:center;justify-content:center;color:#fff;font:700 42px/1.1 system-ui;letter-spacing:.5px;z-index:20';
Â  Â  Â  overlay.textContent = 'GAME OVER';
Â  Â  Â  document.body.appendChild(overlay);
Â  Â  Â  overlay.style.opacity = '1';

Â  Â  Â  // Disable movement and look
Â  Â  Â  const rig = document.getElementById('rig');
Â  Â  Â  rig.removeAttribute('movement-controls');
Â  Â  Â  document.getElementById('player').removeAttribute('look-controls'); 
Â  Â  Â  
Â  Â  Â  const parent = document.getElementById('collectibles');
Â  Â  Â  while (parent.firstChild) parent.removeChild(parent.firstChild);
Â  Â  },

Â  Â  spawnOneBottle(){
Â  Â  Â  if (this.isGameOver) return;
Â  Â  Â  const parent = document.getElementById('collectibles');
Â  Â  Â  while (parent.firstChild) parent.removeChild(parent.firstChild);

Â  Â  Â  // ğŸ“ Uses the fixed 23 unit boundaries for spawning
Â  Â  Â  const x = randRange(-this.halfW, this.halfW);
Â  Â  Â  const z = randRange(-this.halfD, this.halfD);
Â  Â  Â  const y = 0.1;

Â  Â  Â  const e = document.createElement('a-entity');
Â  Â  Â  e.setAttribute('collectible','');
Â  Â  Â  e.setAttribute('gltf-model', '#bottleGLTF');
Â  Â  Â  e.setAttribute('shrink-on-load', 's:0.002');
Â  Â  Â  e.setAttribute('rotation', `0 ${Math.floor(randRange(0,360))} 0`);
Â  Â  Â  e.setAttribute('position', `${x} ${y} ${z}`);
Â  Â  Â  parent.appendChild(e);

Â  Â  Â  setStatus('Bottle spawned â€” collect it to gain +10%!');
Â  Â  }
Â  });

Â  /* Bottle pickup (No changes needed) */
Â  AFRAME.registerComponent('collectible',{
Â  Â  schema:{ radius:{default:1.1} },
Â  Â  init(){
Â  Â  Â  this.player = document.querySelector('#player');
Â  Â  Â  this._removed = false;
Â  Â  Â  this._p = new THREE.Vector3();
Â  Â  Â  this._q = new THREE.Vector3();
Â  Â  },
Â  Â  tick(){
Â  Â  Â  if (this._removed) return;
Â  Â  Â  this.el.object3D.getWorldPosition(this._p);
Â  Â  Â  this.player.object3D.getWorldPosition(this._q);
Â  Â  Â  if (this._p.distanceTo(this._q) < this.data.radius){
Â  Â  Â  Â  this._removed = true;
Â  Â  Â  Â  const parent = this.el.parentNode;
Â  Â  Â  Â  parent && parent.removeChild(this.el);
Â  Â  Â  Â  window.dispatchEvent(new CustomEvent('bottle-collected'));
Â  Â  Â  Â  setStatus('Collected! +10%');
Â  Â  Â  }
Â  Â  }
Â  });

Â  /* Spawn multiple targets at once with separation (Radius remains 25) */
Â  AFRAME.registerComponent('target-spawner',{
Â  Â  schema:{
Â  Â  Â  intervalMin:{default:4000},
Â  Â  Â  intervalMax:{default:7000},
Â  Â  Â  radius:{default:25}, // ğŸ¯ RADIUS: Remains 25 to keep targets in the 50x50 area
Â  Â  Â  count:{default:2},
Â  Â  Â  minSep:{default:6},
Â  Â  Â  deadline:{default:3000},
Â  Â  Â  delay:{default:3000}
Â  Â  },
Â  Â  init(){
Â  Â  Â  this.player = document.querySelector('#rig');
Â  Â  Â  this.game = document.querySelector('#game').components['game-manager'];
Â  Â  Â  this.timer = 0;
Â  Â  Â  this.nextAt = this.nextInterval();
Â  Â  },
Â  Â  nextInterval(){
Â  Â  Â  return Math.random()*(this.data.intervalMax - this.data.intervalMin) + this.data.intervalMin;
Â  Â  },
Â  Â  tick(time,dt){
Â  Â  Â  if(this.game.isGameOver) return;
Â  Â  Â  this.timer += dt;
Â  Â  Â  if(this.timer >= this.nextAt){
Â  Â  Â  Â  this.timer = 0;
Â  Â  Â  Â  this.nextAt = this.nextInterval();
Â  Â  Â  Â  this.spawnTargets();
Â  Â  Â  }
Â  Â  },
Â  Â  spawnTargets(){
Â  Â  Â  const positions = [];
Â  Â  Â  let tries = 0;
Â  Â  Â  while (positions.length < this.data.count && tries < 50) {
Â  Â  Â  Â  Â  const x = Math.random() * (2 * this.data.radius) - this.data.radius;
Â  Â  Â  Â  Â  const z = Math.random() * (2 * this.data.radius) - this.data.radius;
Â  Â  Â  Â  Â  const ok = positions.every(p => Math.hypot(p.x - x, p.z - z) >= this.data.minSep);
Â  Â  Â  Â  Â  if (ok) positions.push({ x, z });
Â  Â  Â  Â  Â  tries++;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Spawn the first target immediately
Â  Â  Â  if (positions[0]) {
Â  Â  Â  Â  Â  const p = positions[0];
Â  Â  Â  Â  Â  const t = document.createElement('a-entity');
Â  Â  Â  Â  Â  t.setAttribute('position', `${p.x} 0.05 ${p.z}`);
Â  Â  Â  Â  Â  t.setAttribute('target-marker', `deadline: ${this.data.deadline}`);
Â  Â  Â  Â  Â  this.el.sceneEl.appendChild(t);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Spawn the second target after the delay
Â  Â  Â  if (positions[1]) {
Â  Â  Â  Â  Â  const p = positions[1];
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  const t = document.createElement('a-entity');
Â  Â  Â  Â  Â  Â  Â  t.setAttribute('position', `${p.x} 0.05 ${p.z}`);
Â  Â  Â  Â  Â  Â  Â  t.setAttribute('target-marker', `deadline: ${this.data.deadline}`);
Â  Â  Â  Â  Â  Â  Â  this.el.sceneEl.appendChild(t);
Â  Â  Â  Â  Â  }, this.data.delay);
Â  Â  Â  }
Â  Â  }
Â  });

Â  /* Target (kills on touch immediately). After deadline, spawns a shark there. */
Â  AFRAME.registerComponent('target-marker',{
Â  Â  schema:{ deadline:{default:3000}, hitRadius:{default:4.2} },
Â  Â  init(){
Â  Â  Â  const ring = document.createElement('a-entity');
Â  Â  Â  ring.setAttribute('geometry','primitive: torus; radius: 5.0; radiusTubular: 0.05; arc: 360');
Â  Â  Â  ring.setAttribute('material','color:#ff2b2b; emissive:#a10000; emissiveIntensity:0.6');
Â  Â  Â  ring.setAttribute('rotation','90 0 0');
Â  Â  Â  ring.setAttribute('animation','property: material.emissiveIntensity; dir: alternate; dur: 500; loop: true; to: 1.2');
Â  Â  Â  this.el.appendChild(ring);

Â  Â  Â  const disk = document.createElement('a-entity');
Â  Â  Â  disk.setAttribute('geometry','primitive: circle; radius: 4.8');
Â  Â  Â  disk.setAttribute('material','color:#aa0000; opacity:0.5; side:double; depthTest:false');
Â  Â  Â  disk.setAttribute('rotation','90 0 0'); 
Â  Â  Â  this.el.appendChild(disk);

Â  Â  Â  this.start = performance.now();
Â  Â  Â  this.player = document.querySelector('#rig');
Â  Â  Â  this.game = document.querySelector('#game').components['game-manager'];
Â  Â  Â  this.resolved = false;
Â  Â  Â  setStatus('Target appeared! Move away!');
Â  Â  },
Â  Â  tick(){
Â  Â  Â  if(this.game.isGameOver || this.resolved) return;

Â  Â  Â  const now = performance.now();

Â  Â  Â  // Time to trigger shark?
Â  Â  Â  if(now - this.start >= this.data.deadline){
Â  Â  Â  Â  this.resolved = true;
Â  Â  Â  Â  const pos = this.el.getAttribute('position'); // scene coords
Â  Â  Â  Â  const shark = document.createElement('a-entity');
Â  Â  Â  Â  shark.setAttribute('position', `${pos.x} -0.8 ${pos.z}`); // start below water
Â  Â  Â  Â  shark.setAttribute('gltf-model', '#sharkGLTF');
Â  Â  Â  Â  shark.setAttribute('shrink-on-load', 's:0.5');Â 
Â  Â  Â  Â  shark.setAttribute('animation-mixer', 'clip:*; loop:once; timeScale:1');
Â  Â  Â  Â  shark.setAttribute('shark-attack','rise:900; hold:600; fall:900; hitRadius:1.0');
Â  Â  Â  Â  this.el.sceneEl.appendChild(shark);

Â  Â  Â  Â  // remove the red marker once shark is spawned
Â  Â  Â  Â  this.el.parentNode && this.el.parentNode.removeChild(this.el);
Â  Â  Â  }
Â  Â  }
Â  });
Â Â 
Â  AFRAME.registerComponent('shark-threat-zone', {
Â  Â  schema: { hitRadius: { default: 1.0 } },
Â  Â  init() {
Â  Â  Â  this.player = document.querySelector('#rig');
Â  Â  Â  this.game = document.querySelector('#game').components['game-manager'];
Â  Â  Â  this.shark = this.el.closest('[shark-attack]');
Â  Â  Â  if (!this.shark) {
Â  Â  Â  Â  console.error('shark-threat-zone must be a child of a shark-attack entity.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Player is at Y=0.3. Shark apex is at Y=0.0. An offset of 1.0 positions the sphere right on the player's height.
Â  Â  Â  this.el.setAttribute('position', '0 1.0 0');Â 
Â  Â  },
Â  Â  tick() {
Â  Â  Â  if (this.game.isGameOver) return;
Â  Â  Â Â 
Â  Â  Â  const p = new THREE.Vector3();
Â  Â  Â  const q = new THREE.Vector3();
Â  Â  Â  this.el.object3D.getWorldPosition(p);
Â  Â  Â  this.player.object3D.getWorldPosition(q);
Â  Â  Â Â 
Â  Â  Â  // Check distance from the player's world position to the threat zone's world position
Â  Â  Â  if (p.distanceTo(q) < this.data.hitRadius) {
Â  Â  Â  Â  this.game.gameOver();
Â  Â  Â  }
Â  Â  }
Â  });

Â  /* Shark rises, holds, falls; touching it -> game over */
Â  AFRAME.registerComponent('shark-attack', {
Â  Â  schema: {
Â  Â  Â  rise:{default:900}, hold:{default:600}, fall:{default:900},
Â  Â  Â  startY:{default:-0.8},Â 
Â  Â  Â  apexY:{default: 0.0}Â 
Â  Â  },
Â  Â  init(){
Â  Â  Â  this.t0 = performance.now();
Â  Â  Â Â 
Â  Â  Â  // Create a threat zone
Â  Â  Â  this.threatZone = document.createElement('a-entity');
Â  Â  Â  this.threatZone.setAttribute('shark-threat-zone', `hitRadius: 2.0`);
Â  Â  Â  this.el.appendChild(this.threatZone);
Â  Â  Â Â 
Â  Â  Â  const pos = this.el.getAttribute('position');
Â  Â  Â  this.x = pos.x; this.z = pos.z;
Â  Â  Â  this.el.setAttribute('rotation', `0 ${Math.floor(randRange(0,360))} 0`);
Â  Â  },
Â  Â  tick(){
Â  Â  Â  const now = performance.now();
Â  Â  Â  const t = now - this.t0;
Â  Â  Â  const {rise, hold, fall, startY, apexY} = this.data;
Â  Â  Â  const total = rise + hold + fall;
Â  Â  Â  let y;

Â  Â  Â  if (t < rise){
Â  Â  Â  Â  const k = t / rise;
Â  Â  Â  Â  y = startY + (apexY - startY) * k;
Â  Â  Â  } else if (t < rise + hold){
Â  Â  Â  Â  y = apexY;
Â  Â  Â  } else if (t < total){
Â  Â  Â  Â  const k = (t - rise - hold) / fall;
Â  Â  Â  Â  y = apexY + (startY - apexY) * k;
Â  Â  Â  } else {
Â  Â  Â  Â  // After the animation, remove the shark and its threat zone
Â  Â  Â  Â  this.el.parentNode.removeChild(this.el);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  this.el.setAttribute('position', `${this.x} ${y} ${this.z}`);
Â  Â  }
Â  });
Â  </script>
</body>
</html>
