<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ocean Survival — A-Frame</title>
  <!-- A-Frame core -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <!-- Community components -->
  <script src="https://unpkg.com/@c-frame/aframe-particle-system-component@1.2.x/dist/aframe-particle-system-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-simple-sun-sky@^1.2.2/simple-sun-sky.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
  <style>
    body { margin:0; }
    .hud { position: fixed; left: 12px; top: 12px; font: 14px/1.4 system-ui, sans-serif; color: #fff; z-index: 10; }
    .hud .pill { background: rgba(0,0,0,.45); padding: 8px 10px; border-radius: 10px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <div class="hud">
    <div class="pill">WASD to move • Mouse to look • Enter VR if supported</div>
    <div class="pill">Avoid the glowing red circles. Stay safe!</div>
    <div id="meter" class="pill">Survival: 100%</div>
    <div id="status" class="pill">Status: Ready</div>
  </div>

  <a-scene>
    <!-- ASSETS -->
    <a-assets timeout="30000">
      <a-asset-item id="bottleGLTF" src="./assets/models/military_water_bottle/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- Rain -->
    <a-entity id="rain" particle-system="preset: rain; color: #aee7ff; particleCount: 20"></a-entity>

    <!-- Ocean -->
    <a-entity id="ocean" ocean="density: 20; width: 50; depth: 50; speed: 4"
              material="color: #192f3d; opacity: 0.75; metalness: 0; roughness: 1"
              rotation="-90 0 0"></a-entity>

    <a-simple-sun-sky sun-position="1 0.4 0"></a-simple-sun-sky>
    <a-entity light="type: ambient; color: #888"></a-entity>

    <!-- Player rig (lower if you want easier collection) -->
    <a-entity id="rig" position="0 0.7 0">
      <a-entity id="player" camera look-controls wasd-controls="acceleration: 8" position="0 -0.3 0"></a-entity>
    </a-entity>

    <!-- Single-bottle container -->
    <a-entity id="collectibles"></a-entity>

    <!-- Target spawner controller -->
    <a-entity id="game" game-manager target-spawner="intervalMin: 4000; intervalMax: 7000; radius: 25"></a-entity>
  </a-scene>

  <script>
  function randRange(min,max){ return Math.random()*(max-min)+min; }
  const statusEl = document.getElementById('status');
  const meterEl = document.getElementById('meter');
  function setStatus(t){ statusEl.textContent = 'Status: ' + t; }
  function setMeter(v){ meterEl.textContent = 'Survival: ' + Math.round(v) + '%'; }

  /* Keep your existing bottle size (do not change s unless you want a different size) */
  AFRAME.registerComponent('shrink-on-load', {
    schema: { s: {default: 0.002} },
    init () {
      const apply = () => this.el.object3D.scale.setScalar(this.data.s);
      if (this.el.getObject3D('mesh')) apply();
      this.el.addEventListener('model-loaded', apply, {once:true});
    }
  });

  /* NEW: gentle floating/bobbing + slight tilt, like it’s on water */
  AFRAME.registerComponent('floaty', {
    schema: {
      ampY:   {default: 0.06},   // vertical bob (meters)
      ampXZ:  {default: 0.02},   // tiny horizontal drift (meters)
      tilt:   {default: 3},      // tilt amplitude (degrees)
      speed:  {default: 0.25}    // cycles per second (0.25 = 4s per cycle)
    },
    init(){
      this._t0 = performance.now() * 0.001 + Math.random()*Math.PI*2; // random phase
      this._basePos = this.el.object3D.position.clone();
      this._baseRot = this.el.object3D.rotation.clone();
      this._TAU = Math.PI * 2;
      this._d2r = Math.PI / 180;
    },
    tick(){
      const t = (performance.now()*0.001 - this._t0) * this.data.speed;
      const s = Math.sin(t * this._TAU);
      const c = Math.cos(t * this._TAU);

      // Position: bob on Y, tiny lazy circle in XZ
      const x = this._basePos.x + c * this.data.ampXZ;
      const y = this._basePos.y + s * this.data.ampY;
      const z = this._basePos.z + s * this.data.ampXZ;

      // Rotation: gentle roll/pitch, keep Y (heading) unchanged
      const rx = this._baseRot.x + (s * this.data.tilt * 0.5) * this._d2r;
      const ry = this._baseRot.y; // don’t fight your random Y heading
      const rz = this._baseRot.z + (c * this.data.tilt) * this._d2r;

      this.el.object3D.position.set(x, y, z);
      this.el.object3D.rotation.set(rx, ry, rz);
    }
  });

  AFRAME.registerComponent('game-manager', {
    init(){
      this.isGameOver = false;
      this.player = document.querySelector('#rig');
      this.black = this.makeOverlay();

      // Ocean bounds for random placement
      const oceanEl = document.getElementById('ocean');
      const oceanData = oceanEl ? oceanEl.getAttribute('ocean') || {} : {};
      this.halfW = (oceanData.width || 50) / 2 - 2;
      this.halfD = (oceanData.depth || 50) / 2 - 2;

      // Survival meter
      this.survival = 100;           // starts at 100%
      setMeter(this.survival);
      this.decayTimer = setInterval(() => {
        if (!this.isGameOver) this.adjustSurvival(-10);   // -10% every 10s
      }, 10000);

      // Bottle events
      this.isSpawning = false;
      window.addEventListener('bottle-collected', () => {
        this.adjustSurvival(+10);     // +10% on collect
        this.spawnIfNone();           // respawn next bottle
      });

      // Start with exactly one bottle
      this.spawnIfNone();
    },

    adjustSurvival(delta){
      if (this.isGameOver) return;
      this.survival = Math.max(0, Math.min(100, this.survival + delta));
      setMeter(this.survival);
      if (this.survival <= 0){
        setStatus('Energy depleted.');
        this.gameOver();
      }
    },

    spawnIfNone(){
      if (this.isGameOver) return;
      const parent = document.getElementById('collectibles');
      if (this.isSpawning || parent.childElementCount > 0) return;
      this.isSpawning = true;
      setTimeout(() => {
        this.spawnOneBottle();
        this.isSpawning = false;
      }, 0);
    },

    makeOverlay(){
      const o = document.createElement('div');
      o.style.cssText = 'position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;transition:opacity .6s;display:flex;align-items:center;justify-content:center;color:#fff;font:700 42px/1.1 system-ui;letter-spacing:.5px;z-index:20';
      o.textContent = 'GAME OVER';
      document.body.appendChild(o);
      return o;
    },

    gameOver(){
      if(this.isGameOver) return;
      this.isGameOver = true;
      setStatus('Game Over');
      if (this.decayTimer) { clearInterval(this.decayTimer); this.decayTimer = null; }
      this.black.style.opacity = '1';
      const cam = document.getElementById('player');
      cam.removeAttribute('wasd-controls');
      cam.removeAttribute('look-controls');
      // Optional: clear bottle
      const parent = document.getElementById('collectibles');
      while (parent.firstChild) parent.removeChild(parent.firstChild);
    },

    spawnOneBottle(){
      if (this.isGameOver) return;
      const parent = document.getElementById('collectibles');
      while (parent.firstChild) parent.removeChild(parent.firstChild);

      const x = randRange(-this.halfW, this.halfW);
      const z = randRange(-this.halfD, this.halfD);
      const y = 0.1; // lower above waves (tweak if needed)

      const e = document.createElement('a-entity');
      e.setAttribute('collectible','');                   // collision logic
      e.setAttribute('gltf-model', '#bottleGLTF');        // your model
      e.setAttribute('shrink-on-load', 's:0.002');        // keep current scale
      e.setAttribute('floaty', 'ampY:0.06; ampXZ:0.02; tilt:3; speed:0.25');  <!-- NEW -->
      e.setAttribute('rotation', `0 ${Math.floor(randRange(0,360))} 0`);
      e.setAttribute('position', `${x} ${y} ${z}`);
      parent.appendChild(e);

      setStatus('Bottle spawned — collect it to gain +10%!');
    }
  });

  // Bottle disappears on camera touch + notify manager to spawn next
  AFRAME.registerComponent('collectible',{
    schema:{ radius:{default:1.1} }, // a bit wider for easier pickup with low camera
    init(){
      this.player = document.querySelector('#player');
      this._removed = false;
      this._p = new THREE.Vector3();
      this._q = new THREE.Vector3();
    },
    tick(){
      if (this._removed) return;
      this.el.object3D.getWorldPosition(this._p);
      this.player.object3D.getWorldPosition(this._q);
      if (this._p.distanceTo(this._q) < this.data.radius){
        this._removed = true;
        const parent = this.el.parentNode;
        parent && parent.removeChild(this.el);
        window.dispatchEvent(new CustomEvent('bottle-collected'));
        setStatus('Collected! +10%');
      }
    }
  });

  AFRAME.registerComponent('target-spawner',{
    schema:{ intervalMin:{default:4000}, intervalMax:{default:7000}, radius:{default:25} },
    init(){
      this.player = document.querySelector('#rig');
      this.game = document.querySelector('#game').components['game-manager'];
      this.timer = 0; this.nextAt = this.nextInterval();
    },
    nextInterval(){ return randRange(this.data.intervalMin, this.data.intervalMax); },
    tick(time,dt){
      if(this.game.isGameOver) return;
      this.timer += dt;
      if(this.timer >= this.nextAt){
        this.timer = 0; this.nextAt = this.nextInterval();
        this.spawnTarget();
      }
    },
    spawnTarget(){
      const x = randRange(-this.data.radius, this.data.radius);
      const z = randRange(-this.data.radius, this.data.radius);
      const y = 0.05;
      const t = document.createElement('a-entity');
      t.setAttribute('position', `${x} ${y} ${z}`);
      t.setAttribute('target-marker','deadline: 3000');
      this.el.sceneEl.appendChild(t);
    }
  });

  AFRAME.registerComponent('target-marker',{
    schema:{ deadline:{default:3000}, hitRadius:{default:4.2} },
    init(){
      const ring = document.createElement('a-entity');
      ring.setAttribute('geometry','primitive: torus; radius: 5.0; radiusTubular: 0.05; arc: 360');
      ring.setAttribute('material','color:#ff2b2b; emissive:#a10000; emissiveIntensity:0.6');
      ring.setAttribute('rotation','90 0 0');
      ring.setAttribute('animation','property: material.emi
